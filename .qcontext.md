# JPC Eats - Project Context

## Project Goal

Rewrite the frontend React application while maintaining the existing backend infrastructure and build configuration.

## Reference Implementation

Original source code is preserved at `/Users/xss/repo/jpc-eats-2` for reference during the rewrite.

## What to Keep (DO NOT MODIFY)

- **Backend**: All Amplify Gen 2 resources in `/amplify` (data models, functions, auth rules, CDK resources)
- **Icons**: All icons in `/icons`
- **Build Strategy**: Capacitor configuration and build setup
- **PWA Structure**: Everything in `/public`
- **MUI Dependencies**: Keep Material-UI for tabbed layout interface

## Frontend Rewrite Goals (`/src`)

### Technology Stack

- **State Management**: TanStack Query (react-query) for server state
- **UI Components**: Amplify UI React component library
- **Native Features**: Capacitor functions (e.g., `@capacitor/geolocation`)
- **Architecture**: Providers + Hooks pattern

### Key Requirements

#### Authentication UX

- App is fully browsable without authentication
- Users can search for food and see entire UI when signed out
- Header always shows login status clearly
- Users redirected to sign-in page only when attempting auth-required actions:
  - Adding a restaurant to rotation
  - Nominating an option
  - Any other write operations

#### Data Management

- Use TanStack Query for data fetching/caching
- Implement providers/hooks for Amplify subscriptions
- Keep subscription management simple and centralized

#### Code Patterns

- Provider pattern for global state (auth, subscriptions)
- Custom hooks for data operations
- Clean separation of concerns
- **Every file must be < 200 lines** - break into smaller components when needed
- Keep components and files simple and focused on single responsibility

#### Design Philosophy

- **Mobile-first**: Primary use case is mobile devices
- Desktop/web scaling is optional - mobile experience is first-class
- Optimize layouts, touch targets, and interactions for mobile screens

---

## Current Structure Audit

### Directory Structure

```
/Users/xss/repo/jpc-eats/
├── amplify/          # Backend resources (KEEP)
├── icons/            # App icons (KEEP)
├── public/           # PWA assets (KEEP)
└── src/              # Frontend code (REWRITE)
    ├── App.tsx       # Main app component with all state management
    ├── main.tsx      # Entry point with Amplify config
    ├── entities.ts   # Data layer with Amplify client and subscriptions
    ├── hooks/
    │   └── useAuth.tsx
    └── components/
        ├── Header.tsx
        ├── Footer.tsx
        ├── TabsView.tsx
        ├── AuthenticatorModal.tsx
        ├── PlaceSearchPage.tsx
        ├── PlaceListPage/
        │   └── PlaceCard.tsx
        ├── RotationPage.tsx
        ├── OptionsPage/
        │   ├── CurrentOptions.tsx
        │   └── PastChoices.tsx
        ├── StatsPage.tsx
        └── SettingsPage/
            ├── Preferences.tsx
            └── SignOutButton.tsx
```

### Current Implementation Analysis

#### Current Auth Flow

- **Auth Provider**: `useAuth` hook with context pattern ✅ (GOOD - keep this pattern)
- **Auth State**: Tracks user, loading state, signOut function
- **Auth Events**: Listens to Amplify Hub for signedIn/signedOut events
- **Modal Pattern**: Uses `AuthenticatorModal` component that shows Amplify Authenticator
- **Problem**: Auth is NOT enforced - modal is triggered by `requireAuth()` callback passed down through props
- **Problem**: Header doesn't show login status

#### Current Data Fetching

- **Direct Amplify Calls**: All data fetching in `entities.ts` using `generateClient()`
- **No React Query**: Direct async calls with manual state management
- **Local Storage**: Heavy use of localStorage for caching (rotation, choices, preferences, coordinates)
- **Manual Refresh**: `refreshAllData()` function called on app resume and after subscriptions fire
- **Problem**: No automatic cache invalidation or refetching
- **Problem**: Subscriptions trigger full data refresh with 500ms delay (inefficient)

#### Current Subscription Management

- **Location**: All subscription setup in `App.tsx` useEffect
- **Pattern**: Individual listeners for create/update/delete operations
- **Cleanup**: Proper unsubscribe on unmount
- **Problem**: Subscriptions only set up when user is authenticated (good!)
- **Problem**: Each subscription updates local state AND triggers full refresh (redundant)
- **Problem**: Subscription logic mixed with component logic

#### Current Component Structure

- **Monolithic App.tsx**: 300+ lines with all state, subscriptions, geolocation
- **Prop Drilling**: `user`, `rotation`, `choices`, `preferences`, `refreshData`, `requireAuth` passed through TabsView to all pages
- **Page Components**: Separate components for each tab (Search, List, Rotation, Options, Stats, Settings)
- **Amplify UI**: Already using `@aws-amplify/ui-react` components (Card, View, Heading, etc.)
- **Problem**: No separation of concerns - everything in App.tsx
- **Problem**: Heavy prop drilling instead of context/hooks

#### Current State Management

- **Local State**: All in App.tsx (rotation, choices, preferences, youAreHere, showAuthModal)
- **localStorage**: Used as persistent cache layer
- **No Global State**: Everything passed via props
- **Geolocation**: Fetched once on mount, stored in localStorage
- **Problem**: No centralized state management
- **Problem**: No optimistic updates

#### Current Dependencies

**Already Installed:**

- `@aws-amplify/ui-react` ✅
- `@capacitor/geolocation` ✅
- `@capacitor/app` ✅
- `aws-amplify` ✅

**Need to Add:**

- `@tanstack/react-query`
- `@tanstack/react-query-devtools` (dev)

**Can Remove (if not used elsewhere):**

- None - keeping MUI for tabbed interface

### Migration Strategy

#### Phase 1: Setup Infrastructure

1. Install TanStack Query
2. Create query client and provider
3. Create data hooks using TanStack Query
4. Create subscription provider/hooks

#### Phase 2: Refactor Data Layer

1. Move `entities.ts` functions to TanStack Query hooks
2. Create `useRotation`, `useChoices`, `usePreferences` hooks
3. Create subscription hooks that invalidate queries
4. Remove manual localStorage management (let TanStack Query handle caching)

#### Phase 3: Refactor Auth Flow

1. Keep existing `useAuth` hook (it's good!)
2. Create auth guard HOC or hook for protected actions
3. Update Header to show login status
4. Implement redirect-to-signin pattern

#### Phase 4: Refactor Components

1. Create new page components using hooks instead of props
2. Remove prop drilling - use hooks directly
3. Simplify App.tsx to just providers and routing
4. Keep Amplify UI components

#### Phase 5: Polish

1. Remove unused dependencies
2. Add loading states with Amplify UI Loader
3. Add error boundaries
4. Test auth flows
